import { RowSelectToggleType } from './row-select-toggle-type';
import { RowSelectionMode, RowSelectionType } from '../api/row-selected/row-selection';
import { FormationSelection } from './selection/formation.selection';
import { SelectionModeSetAggregateEvent } from '../core/mode/selection-mode-set.aggregate-event';
import { SelectionTypeSetAggregateEvent } from '../core/type/selection-type-set.aggregate-event';
import { SelectionEnabledSetAggregateEvent } from '../core/set-enabled/selection-enabled-set.aggregate-event';
import { ItemEntityId } from '../../../source/src/domain/item/item.entity-id';
import { FormationCustomSelectId } from '../api/custom/formation.custom-select.id';
import { FormationCustomManager } from './custom/formation.custom.manager';
import { FormationCustomSelectionChangeAggregateEvent } from '../core/custom/formation.custom-selection-change.aggregate-event';
import { FormationCustomSelection, FormationCustomSelectionFunctionModel } from '../api/custom/formation.custom-selection';
export class FormationManager {
    constructor(id, selectedItemIds) {
        this.id = id;
        this.selectedItemIds = selectedItemIds;
        this.selection = new FormationSelection(RowSelectionMode.SINGLE, RowSelectionType.ROW);
        this.matcher = (item) => item.id;
    }
    init(enabled, mode, type) {
        this.enabled = enabled;
        this.selection.setMode(mode);
        this.selection.setType(type);
        this.customSelection = new FormationCustomManager(false, [
            new FormationCustomSelectionFunctionModel('select_all', 'SELECT_ALL', new FormationCustomSelectId('SELECT_ALL'), true),
            new FormationCustomSelectionFunctionModel('UNSELECT_ALL', 'UNSELECT_ALL', new FormationCustomSelectId('UNSELECT_ALL'), true),
            new FormationCustomSelectionFunctionModel('', 'INVERT', new FormationCustomSelectId('INVERT'), true)
        ]);
        return [
            new SelectionEnabledSetAggregateEvent(this.getId(), this.enabled),
            new SelectionModeSetAggregateEvent(this.getId(), this.selection.getMode()),
            new SelectionTypeSetAggregateEvent(this.getId(), this.selection.getType()),
            new FormationCustomSelectionChangeAggregateEvent(this.getId(), new FormationCustomSelection(this.customSelection.isEnabled(), this.customSelection.getSelections()))
        ];
    }
    setSelection(enabled) {
        this.enabled = enabled;
        return [
            new SelectionEnabledSetAggregateEvent(this.getId(), this.enabled)
        ];
    }
    setMode(mode) {
        this.selection.setMode(mode);
        return [
            new SelectionModeSetAggregateEvent(this.getId(), this.selection.getMode()),
            new SelectionTypeSetAggregateEvent(this.getId(), this.selection.getType())
        ];
    }
    setType(type) {
        this.selection.setType(type);
        return [
            new SelectionModeSetAggregateEvent(this.getId(), this.selection.getMode()),
            new SelectionTypeSetAggregateEvent(this.getId(), this.selection.getType())
        ];
    }
    setMatcher(matcher) {
        this.matcher = matcher;
    }
    setCustomConfig(config) {
        if (config?.enabled) {
            this.customSelection.setEnabled(config.enabled);
        }
        if (config?.selections) {
            this.customSelection.setSelections(config.selections);
        }
        return [
            new FormationCustomSelectionChangeAggregateEvent(this.getId(), new FormationCustomSelection(this.customSelection.isEnabled(), this.customSelection.getSelections()))
        ];
    }
    isAllSelected() {
        return this.allSelected;
    }
    isAllUnselected() {
        return this.allUnselected;
    }
    getSelectedItemIds() {
        return Array.from(this.selectedItemIds).map(id => new ItemEntityId(id));
    }
    selectCustom(id, itemEntities) {
        this.customSelection
            .findSelection(id)
            .ifPresent((s) => {
            if (s.isBuiltIn()) {
                switch (s.getCustomSelectId().toString()) {
                    case 'SELECT_ALL':
                        this.selectAll(itemEntities.map(i => i.getId()));
                        break;
                    case 'UNSELECT_ALL':
                        this.unselectAll();
                        break;
                    case 'INVERT':
                        this.invertSelected(itemEntities.map(i => i.getId()));
                        break;
                    default:
                        break;
                }
            }
            else {
                const selectedItems = s.customSelect(itemEntities);
                this.selectedItemIds = new Set(selectedItems.map(item => item.getId().toString()));
            }
        });
    }
    selectAll(allEntityIds) {
        this.selectedItemIds = new Set(allEntityIds.map(id => id.toString()));
        this.allSelected = true;
        this.allUnselected = false;
    }
    unselectAll() {
        this.selectedItemIds.clear();
        this.allSelected = false;
        this.allUnselected = true;
    }
    invertSelected(allEntityIds) {
        const selectedItemIds = this.getSelectedItemIds();
        const a = allEntityIds.filter((id) => {
            return !selectedItemIds.some((selId) => selId.equals(id));
        });
        this.selectedItemIds = new Set(a.map(id => id.toString()));
        this.calculateAllSelected(allEntityIds);
        this.calculateAllUnselected();
    }
    reSelectByIds(itemEntities) {
        this.selectByIds(this.getSelectedItemIds().map(i => i.getId()), itemEntities);
        this.calculateAllSelected(itemEntities.map(i => i.getId()));
        this.calculateAllUnselected();
    }
    selectByIds(ids, itemEntities) {
        if (!this.enabled) {
            return;
        }
        const itemIds = [];
        for (let i = 0; i < ids.length; i++) {
            const items = itemEntities
                .filter((item) => {
                return this.matcher(item.getSourceItem()) === ids[i];
            })
                .map((item) => item.getId().toString());
            itemIds.push(...items);
        }
        let type = RowSelectToggleType.ADD;
        if (this.selection.isSingle()) {
            type = RowSelectToggleType.NONE;
        }
        itemIds.forEach((id) => {
            this.toggleRowByType(type, id);
        });
        this.calculateAllSelected(itemEntities.map(i => i.getId()));
        this.calculateAllUnselected();
    }
    selectByIndex(indexes, allEntityIds) {
        if (!this.enabled) {
            return;
        }
        const itemIds = indexes.map((i) => {
            if (!allEntityIds[i]) {
                console.error('Item not found');
            }
            return allEntityIds[i].toString();
        });
        let type = RowSelectToggleType.ADD;
        if (this.selection.isSingle()) {
            type = RowSelectToggleType.NONE;
        }
        itemIds.forEach((id) => {
            this.toggleRowByType(type, id);
        });
        this.calculateAllSelected(allEntityIds);
        this.calculateAllUnselected();
    }
    selectRows(itemIds, itemEntityIds) {
    }
    toggleRow(itemId, type, itemEntityIds) {
        if (!this.enabled) {
            return;
        }
        if (type === RowSelectToggleType.ADD && this.selection.isSingle()) {
            type = RowSelectToggleType.NONE;
        }
        this.toggleRowByType(type, itemId);
        this.calculateAllSelected(itemEntityIds);
        this.calculateAllUnselected();
    }
    calculateAllSelected(itemEntityIds) {
        if (itemEntityIds.length !== this.selectedItemIds.size) {
            this.allSelected = false;
        }
        else {
            const rows = Array.from(this.selectedItemIds);
            let equal = true;
            rows.sort();
            itemEntityIds.sort();
            for (let i = 0; i < rows.length; i += 1) {
                if (rows[i] !== itemEntityIds[i].toString()) {
                    equal = false;
                    break;
                }
            }
            this.allSelected = equal;
        }
    }
    calculateAllUnselected() {
        this.allUnselected = this.selectedItemIds.size === 0;
    }
    unselectRow(itemEntityId) {
        if (this.selectedItemIds.has(itemEntityId.toString())) {
            this.selectedItemIds.delete(itemEntityId.toString());
        }
    }
    getId() {
        return this.id;
    }
    getType() {
        return this.selection.getType();
    }
    toggleRowByType(type, itemId) {
        switch (type) {
            case RowSelectToggleType.NONE:
                if (this.selectedItemIds.has(itemId)) {
                    this.selectedItemIds.delete(itemId);
                }
                else {
                    this.selectedItemIds.clear();
                    this.selectedItemIds.add(itemId);
                }
                break;
            case RowSelectToggleType.ADD:
                if (this.selectedItemIds.has(itemId)) {
                    this.selectedItemIds.delete(itemId);
                }
                else {
                    this.selectedItemIds.add(itemId);
                }
                break;
            case RowSelectToggleType.RANGE:
                break;
            default:
                break;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybWF0aW9uLm1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9idWlsZC1jbGkvcHJvamVjdHMvbmd4LWdyaWQvc3JjL2NvcmUvc3RydWN0dXJlL2Zvcm1hdGlvbi9zcmMvZG9tYWluL2Zvcm1hdGlvbi5tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQ3ZGLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBRXJFLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLGlEQUFpRCxDQUFDO0FBRWpHLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLGlEQUFpRCxDQUFDO0FBQ2pHLE9BQU8sRUFBRSxpQ0FBaUMsRUFBRSxNQUFNLDJEQUEyRCxDQUFDO0FBQzlHLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnREFBZ0QsQ0FBQztBQUU5RSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUNuRixPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUMzRSxPQUFPLEVBQUUsNENBQTRDLEVBQUUsTUFBTSxrRUFBa0UsQ0FBQztBQUNoSSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUscUNBQXFDLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUczSCxNQUFNLE9BQU8sZ0JBQWdCO0lBYzVCLFlBQW9CLEVBQWUsRUFDeEIsZUFBNEI7UUFEbkIsT0FBRSxHQUFGLEVBQUUsQ0FBYTtRQUN4QixvQkFBZSxHQUFmLGVBQWUsQ0FBYTtRQVgvQixjQUFTLEdBQUcsSUFBSSxrQkFBa0IsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsZ0JBQWdCLENBQUMsR0FBRyxD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QUFtQixDQUFDLElBQUk7Z0JBRTVCLElBQUksSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUU7b0JBQ3JDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2lCQUNwQztxQkFBTTtvQkFDTixJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssRUFBRSxDQUFDO29CQUM3QixJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztpQkFDakM7Z0JBRUQsTUFBTTtZQUVQLEtBQUssbUJBQW1CLENBQUMsR0FBRztnQkFFM0IsSUFBSSxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRTtvQkFDckMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7aUJBQ3BDO3FCQUFNO29CQUNOLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2lCQUNqQztnQkFFRCxNQUFNO1lBRVAsS0FBSyxtQkFBbUIsQ0FBQyxLQUFLO2dCQUU3QixNQUFNO1lBRVA7Z0JBQ0MsTUFBTTtTQUNQO0lBQ0YsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUm93U2VsZWN0VG9nZ2xlVHlwZSB9IGZyb20gJy4vcm93LXNlbGVjdC10b2dnbGUtdHlwZSc7XG5pbXBvcnQgeyBSb3dTZWxlY3Rpb25Nb2RlLCBSb3dTZWxlY3Rpb25UeXBlIH0gZnJvbSAnLi4vYXBpL3Jvdy1zZWxlY3RlZC9yb3ctc2VsZWN0aW9uJztcbmltcG9ydCB7IEZvcm1hdGlvblNlbGVjdGlvbiB9IGZyb20gJy4vc2VsZWN0aW9uL2Zvcm1hdGlvbi5zZWxlY3Rpb24nO1xuaW1wb3J0IHsgU3RydWN0dXJlQWdncmVnYXRlRXZlbnQgfSBmcm9tICcuLi8uLi8uLi9zdHJ1Y3R1cmUtY29yZS9zcmMvY29yZS9zdHJ1Y3R1cmUuYWdncmVnYXRlLWV2ZW50JztcbmltcG9ydCB7IFNlbGVjdGlvbk1vZGVTZXRBZ2dyZWdhdGVFdmVudCB9IGZyb20gJy4uL2NvcmUvbW9kZS9zZWxlY3Rpb24tbW9kZS1zZXQuYWdncmVnYXRlLWV2ZW50JztcbmltcG9ydCB7IFN0cnVjdHVyZUlkIH0gZnJvbSAnLi4vLi4vLi4vc3RydWN0dXJlLWNvcmUvc3JjL2FwaS9nbG9iYWwvc3RydWN0dXJlLmlkJztcbmltcG9ydCB7IFNlbGVjdGlvblR5cGVTZXRBZ2dyZWdhdGVFdmVudCB9IGZyb20gJy4uL2NvcmUvdHlwZS9zZWxlY3Rpb24tdHlwZS1zZXQuYWdncmVnYXRlLWV2ZW50JztcbmltcG9ydCB7IFNlbGVjdGlvbkVuYWJsZWRTZXRBZ2dyZWdhdGVFdmVudCB9IGZyb20gJy4uL2NvcmUvc2V0LWVuYWJsZWQvc2VsZWN0aW9uLWVuYWJsZWQtc2V0LmFnZ3JlZ2F0ZS1ldmVudCc7XG5pbXBvcnQgeyBJdGVtRW50aXR5SWQgfSBmcm9tICcuLi8uLi8uLi9zb3VyY2Uvc3JjL2RvbWFpbi9pdGVtL2l0ZW0uZW50aXR5LWlkJztcbmltcG9ydCB7IEl0ZW1FbnRpdHkgfSBmcm9tICcuLi8uLi8uLi9zb3VyY2Uvc3JjL2RvbWFpbi9pdGVtL2l0ZW0uZW50aXR5JztcbmltcG9ydCB7IEZvcm1hdGlvbkN1c3RvbVNlbGVjdElkIH0gZnJvbSAnLi4vYXBpL2N1c3RvbS9mb3JtYXRpb24uY3VzdG9tLXNlbGVjdC5pZCc7XG5pbXBvcnQgeyBGb3JtYXRpb25DdXN0b21NYW5hZ2VyIH0gZnJvbSAnLi9jdXN0b20vZm9ybWF0aW9uLmN1c3RvbS5tYW5hZ2VyJztcbmltcG9ydCB7IEZvcm1hdGlvbkN1c3RvbVNlbGVjdGlvbkNoYW5nZUFnZ3JlZ2F0ZUV2ZW50IH0gZnJvbSAnLi4vY29yZS9jdXN0b20vZm9ybWF0aW9uLmN1c3RvbS1zZWxlY3Rpb24tY2hhbmdlLmFnZ3JlZ2F0ZS1ldmVudCc7XG5pbXBvcnQgeyBGb3JtYXRpb25DdXN0b21TZWxlY3Rpb24sIEZvcm1hdGlvbkN1c3RvbVNlbGVjdGlvbkZ1bmN0aW9uTW9kZWwgfSBmcm9tICcuLi9hcGkvY3VzdG9tL2Zvcm1hdGlvbi5jdXN0b20tc2VsZWN0aW9uJztcbmltcG9ydCB7IEZvcm1hdGlvbkN1c3RvbVNlbGVjdGlvbkNvbmZpZyB9IGZyb20gJy4uL2FwaS9jdXN0b20vZm9ybWF0aW9uLmN1c3RvbS1zZWxlY3Rpb24uY29uZmlnJztcblxuZXhwb3J0IGNsYXNzIEZvcm1hdGlvbk1hbmFnZXIge1xuXG5cdHByaXZhdGUgZW5hYmxlZDogYm9vbGVhbjtcblxuXHRwcml2YXRlIHNlbGVjdGlvbiA9IG5ldyBGb3JtYXRpb25TZWxlY3Rpb24oUm93U2VsZWN0aW9uTW9kZS5TSU5HTEUsIFJvd1NlbGVjdGlvblR5cGUuUk9XKTtcblxuXHRwcml2YXRlIGFsbFNlbGVjdGVkOiBib29sZWFuO1xuXG5cdHByaXZhdGUgYWxsVW5zZWxlY3RlZDogYm9vbGVhbjtcblxuXHRwcml2YXRlIGN1c3RvbVNlbGVjdGlvbjogRm9ybWF0aW9uQ3VzdG9tTWFuYWdlcjtcblxuXHRwcml2YXRlIG1hdGNoZXI6IChpdGVtOiBhbnkpID0+IGFueSA9IChpdGVtOiBhbnkpID0+IGl0ZW0uaWQ7XG5cblx0Y29uc3RydWN0b3IocHJpdmF0ZSBpZDogU3RydWN0dXJlSWQsXG5cdFx0XHRcdHByaXZhdGUgc2VsZWN0ZWRJdGVtSWRzOiBTZXQ8c3RyaW5nPikge1xuXHR9XG5cblx0aW5pdChlbmFibGVkOiBib29sZWFuLCBtb2RlOiBSb3dTZWxlY3Rpb25Nb2RlLCB0eXBlOiBSb3dTZWxlY3Rpb25UeXBlKTogQXJyYXk8U3RydWN0dXJlQWdncmVnYXRlRXZlbnQ+IHtcblx0XHR0aGlzLmVuYWJsZWQgPSBlbmFibGVkO1xuXHRcdHRoaXMuc2VsZWN0aW9uLnNldE1vZGUobW9kZSk7XG5cdFx0dGhpcy5zZWxlY3Rpb24uc2V0VHlwZSh0eXBlKTtcblx0XHR0aGlzLmN1c3RvbVNlbGVjdGlvbiA9IG5ldyBGb3JtYXRpb25DdXN0b21NYW5hZ2VyKGZhbHNlLCBbXG5cdFx0XHRuZXcgRm9ybWF0aW9uQ3VzdG9tU2VsZWN0aW9uRnVuY3Rpb25Nb2RlbChcblx0XHRcdFx0J3NlbGVjdF9hbGwnLFxuXHRcdFx0XHQnU0VMRUNUX0FMTCcsXG5cdFx0XHRcdG5ldyBGb3JtYXRpb25DdXN0b21TZWxlY3RJZCgnU0VMRUNUX0FMTCcpLFxuXHRcdFx0XHR0cnVlXG5cdFx0XHQpLFxuXHRcdFx0bmV3IEZvcm1hdGlvbkN1c3RvbVNlbGVjdGlvbkZ1bmN0aW9uTW9kZWwoXG5cdFx0XHRcdCdVTlNFTEVDVF9BTEwnLFxuXHRcdFx0XHQnVU5TRUxFQ1RfQUxMJyxcblx0XHRcdFx0bmV3IEZvcm1hdGlvbkN1c3RvbVNlbGVjdElkKCdVTlNFTEVDVF9BTEwnKSxcblx0XHRcdFx0dHJ1ZVxuXHRcdFx0KSxcblx0XHRcdG5ldyBGb3JtYXRpb25DdXN0b21TZWxlY3Rpb25GdW5jdGlvbk1vZGVsKFxuXHRcdFx0XHQnJyxcblx0XHRcdFx0J0lOVkVSVCcsXG5cdFx0XHRcdG5ldyBGb3JtYXRpb25DdXN0b21TZWxlY3RJZCgnSU5WRVJUJyksXG5cdFx0XHRcdHRydWVcblx0XHRcdClcblx0XHRdKTtcblxuXHRcdHJldHVybiBbXG5cdFx0XHRuZXcgU2VsZWN0aW9uRW5hYmxlZFNldEFnZ3JlZ2F0ZUV2ZW50KHRoaXMuZ2V0SWQoKSwgdGhpcy5lbmFibGVkKSxcblx0XHRcdG5ldyBTZWxlY3Rpb25Nb2RlU2V0QWdncmVnYXRlRXZlbnQodGhpcy5nZXRJZCgpLCB0aGlzLnNlbGVjdGlvbi5nZXRNb2RlKCkpLFxuXHRcdFx0bmV3IFNlbGVjdGlvblR5cGVTZXRBZ2dyZWdhdGVFdmVudCh0aGlzLmdldElkKCksIHRoaXMuc2VsZWN0aW9uLmdldFR5cGUoKSksXG5cdFx0XHRuZXcgRm9ybWF0aW9uQ3VzdG9tU2VsZWN0aW9uQ2hhbmdlQWdncmVnYXRlRXZlbnQodGhpcy5nZXRJZCgpLCBuZXcgRm9ybWF0aW9uQ3VzdG9tU2VsZWN0aW9uKHRoaXMuY3VzdG9tU2VsZWN0aW9uLmlzRW5hYmxlZCgpLCB0aGlzLmN1c3RvbVNlbGVjdGlvbi5nZXRTZWxlY3Rpb25zKCkpKVxuXHRcdF07XG5cdH1cblxuXHRzZXRTZWxlY3Rpb24oZW5hYmxlZDogYm9vbGVhbik6IEFycmF5PFN0cnVjdHVyZUFnZ3JlZ2F0ZUV2ZW50PiB7XG5cdFx0dGhpcy5lbmFibGVkID0gZW5hYmxlZDtcblxuXHRcdHJldHVybiBbXG5cdFx0XHRuZXcgU2VsZWN0aW9uRW5hYmxlZFNldEFnZ3JlZ2F0ZUV2ZW50KHRoaXMuZ2V0SWQoKSwgdGhpcy5lbmFibGVkKVxuXHRcdF07XG5cdH1cblxuXHRzZXRNb2RlKG1vZGU6IFJvd1NlbGVjdGlvbk1vZGUpOiBBcnJheTxTdHJ1Y3R1cmVBZ2dyZWdhdGVFdmVudD4ge1xuXHRcdHRoaXMuc2VsZWN0aW9uLnNldE1vZGUobW9kZSk7XG5cblx0XHRyZXR1cm4gW1xuXHRcdFx0bmV3IFNlbGVjdGlvbk1vZGVTZXRBZ2dyZWdhdGVFdmVudCh0aGlzLmdldElkKCksIHRoaXMuc2VsZWN0aW9uLmdldE1vZGUoKSksXG5cdFx0XHRuZXcgU2VsZWN0aW9uVHlwZVNldEFnZ3JlZ2F0ZUV2ZW50KHRoaXMuZ2V0SWQoKSwgdGhpcy5zZWxlY3Rpb24uZ2V0VHlwZSgpKVxuXHRcdF07XG5cdH1cblxuXHRzZXRUeXBlKHR5cGU6IFJvd1NlbGVjdGlvblR5cGUpOiBBcnJheTxTdHJ1Y3R1cmVBZ2dyZWdhdGVFdmVudD4ge1xuXHRcdHRoaXMuc2VsZWN0aW9uLnNldFR5cGUodHlwZSk7XG5cblx0XHRyZXR1cm4gW1xuXHRcdFx0bmV3IFNlbGVjdGlvbk1vZGVTZXRBZ2dyZWdhdGVFdmVudCh0aGlzLmdldElkKCksIHRoaXMuc2VsZWN0aW9uLmdldE1vZGUoKSksXG5cdFx0XHRuZXcgU2VsZWN0aW9uVHlwZVNldEFnZ3JlZ2F0ZUV2ZW50KHRoaXMuZ2V0SWQoKSwgdGhpcy5zZWxlY3Rpb24uZ2V0VHlwZSgpKVxuXHRcdF07XG5cdH1cblxuXHRzZXRNYXRjaGVyKG1hdGNoZXI6IChpdGVtOiBhbnkpID0+IGFueSk6IHZvaWQge1xuXHRcdHRoaXMubWF0Y2hlciA9IG1hdGNoZXI7XG5cdH1cblxuXHRzZXRDdXN0b21Db25maWcoY29uZmlnOiBGb3JtYXRpb25DdXN0b21TZWxlY3Rpb25Db25maWcpOiBBcnJheTxTdHJ1Y3R1cmVBZ2dyZWdhdGVFdmVudD4ge1xuXG5cdFx0aWYgKGNvbmZpZz8uZW5hYmxlZCkge1xuXHRcdFx0dGhpcy5jdXN0b21TZWxlY3Rpb24uc2V0RW5hYmxlZChjb25maWcuZW5hYmxlZCk7XG5cdFx0fVxuXG5cdFx0aWYgKGNvbmZpZz8uc2VsZWN0aW9ucykge1xuXHRcdFx0dGhpcy5jdXN0b21TZWxlY3Rpb24uc2V0U2VsZWN0aW9ucyhjb25maWcuc2VsZWN0aW9ucyk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIFtcblx0XHRcdG5ldyBGb3JtYXRpb25DdXN0b21TZWxlY3Rpb25DaGFuZ2VBZ2dyZWdhdGVFdmVudCh0aGlzLmdldElkKCksIG5ldyBGb3JtYXRpb25DdXN0b21TZWxlY3Rpb24odGhpcy5jdXN0b21TZWxlY3Rpb24uaXNFbmFibGVkKCksIHRoaXMuY3VzdG9tU2VsZWN0aW9uLmdldFNlbGVjdGlvbnMoKSkpXG5cdFx0XTtcblx0fVxuXG5cdGlzQWxsU2VsZWN0ZWQoKTogYm9vbGVhbiB7XG5cdFx0cmV0dXJuIHRoaXMuYWxsU2VsZWN0ZWQ7XG5cdH1cblxuXHRpc0FsbFVuc2VsZWN0ZWQoKTogYm9vbGVhbiB7XG5cdFx0cmV0dXJuIHRoaXMuYWxsVW5zZWxlY3RlZDtcblx0fVxuXG5cdGdldFNlbGVjdGVkSXRlbUlkcygpOiBBcnJheTxJdGVtRW50aXR5SWQ+IHtcblx0XHRyZXR1cm4gQXJyYXkuZnJvbSh0aGlzLnNlbGVjdGVkSXRlbUlkcykubWFwKGlkID0+IG5ldyBJdGVtRW50aXR5SWQoaWQpKTtcblx0fVxuXG5cdHNlbGVjdEN1c3RvbShpZDogRm9ybWF0aW9uQ3VzdG9tU2VsZWN0SWQsIGl0ZW1FbnRpdGllczogQXJyYXk8SXRlbUVudGl0eT4pOiB2b2lkIHtcblxuXHRcdHRoaXMuY3VzdG9tU2VsZWN0aW9uXG5cdFx0XHQuZmluZFNlbGVjdGlvbihpZClcblx0XHRcdC5pZlByZXNlbnQoKHMpID0+IHtcblx0XHRcdFx0aWYgKHMuaXNCdWlsdEluKCkpIHtcblxuXHRcdFx0XHRcdHN3aXRjaCAocy5nZXRDdXN0b21TZWxlY3RJZCgpLnRvU3RyaW5nKCkpIHtcblx0XHRcdFx0XHRcdGNhc2UgJ1NFTEVDVF9BTEwnOlxuXHRcdFx0XHRcdFx0XHR0aGlzLnNlbGVjdEFsbChpdGVtRW50aXRpZXMubWFwKGkgPT4gaS5nZXRJZCgpKSk7XG5cdFx0XHRcdFx0XHRcdGJyZWFrO1xuXG5cdFx0XHRcdFx0XHRjYXNlICdVTlNFTEVDVF9BTEwnOlxuXHRcdFx0XHRcdFx0XHR0aGlzLnVuc2VsZWN0QWxsKCk7XG5cdFx0XHRcdFx0XHRcdGJyZWFrO1xuXG5cdFx0XHRcdFx0XHRjYXNlICdJTlZFUlQnOlxuXHRcdFx0XHRcdFx0XHR0aGlzLmludmVydFNlbGVjdGVkKGl0ZW1FbnRpdGllcy5tYXAoaSA9PiBpLmdldElkKCkpKTtcblx0XHRcdFx0XHRcdFx0YnJlYWs7XG5cblx0XHRcdFx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHR9IGVsc2Uge1xuXG5cdFx0XHRcdFx0Y29uc3Qgc2VsZWN0ZWRJdGVtcyA9IHMuY3VzdG9tU2VsZWN0KGl0ZW1FbnRpdGllcyk7XG5cblx0XHRcdFx0XHR0aGlzLnNlbGVjdGVkSXRlbUlkcyA9IG5ldyBTZXQ8c3RyaW5nPihzZWxlY3RlZEl0ZW1zLm1hcChpdGVtID0+IGl0ZW0uZ2V0SWQoKS50b1N0cmluZygpKSk7XG5cdFx0XHRcdH1cblx0XHRcdH0pO1xuXHR9XG5cblx0c2VsZWN0QWxsKGFsbEVudGl0eUlkczogQXJyYXk8SXRlbUVudGl0eUlkPik6IHZvaWQge1xuXHRcdHRoaXMuc2VsZWN0ZWRJdGVtSWRzID0gbmV3IFNldDxzdHJpbmc+KGFsbEVudGl0eUlkcy5tYXAoaWQgPT4gaWQudG9TdHJpbmcoKSkpO1xuXHRcdHRoaXMuYWxsU2VsZWN0ZWQgPSB0cnVlO1xuXHRcdHRoaXMuYWxsVW5zZWxlY3RlZCA9IGZhbHNlO1xuXHR9XG5cblx0dW5zZWxlY3RBbGwoKTogdm9pZCB7XG5cdFx0dGhpcy5zZWxlY3RlZEl0ZW1JZHMuY2xlYXIoKTtcblx0XHR0aGlzLmFsbFNlbGVjdGVkID0gZmFsc2U7XG5cdFx0dGhpcy5hbGxVbnNlbGVjdGVkID0gdHJ1ZTtcblx0fVxuXG5cdGludmVydFNlbGVjdGVkKGFsbEVudGl0eUlkczogQXJyYXk8SXRlbUVudGl0eUlkPik6IHZvaWQge1xuXG5cdFx0Y29uc3Qgc2VsZWN0ZWRJdGVtSWRzID0gdGhpcy5nZXRTZWxlY3RlZEl0ZW1JZHMoKTtcblxuXHRcdGNvbnN0IGEgPSBhbGxFbnRpdHlJZHMuZmlsdGVyKChpZCkgPT4ge1xuXHRcdFx0cmV0dXJuICFzZWxlY3RlZEl0ZW1JZHMuc29tZSgoc2VsSWQpID0+IHNlbElkLmVxdWFscyhpZCkpO1xuXHRcdH0pO1xuXG5cdFx0dGhpcy5zZWxlY3RlZEl0ZW1JZHMgPSBuZXcgU2V0PHN0cmluZz4oYS5tYXAoaWQgPT4gaWQudG9TdHJpbmcoKSkpO1xuXHRcdHRoaXMuY2FsY3VsYXRlQWxsU2VsZWN0ZWQoYWxsRW50aXR5SWRzKTtcblx0XHR0aGlzLmNhbGN1bGF0ZUFsbFVuc2VsZWN0ZWQoKTtcblx0fVxuXG5cdHJlU2VsZWN0QnlJZHMoaXRlbUVudGl0aWVzOiBBcnJheTxJdGVtRW50aXR5Pik6IHZvaWQge1xuXHRcdHRoaXMuc2VsZWN0QnlJZHModGhpcy5nZXRTZWxlY3RlZEl0ZW1JZHMoKS5tYXAoaSA9PiBpLmdldElkKCkpLCBpdGVtRW50aXRpZXMpO1xuXHRcdHRoaXMuY2FsY3VsYXRlQWxsU2VsZWN0ZWQoaXRlbUVudGl0aWVzLm1hcChpID0+IGkuZ2V0SWQoKSkpO1xuXHRcdHRoaXMuY2FsY3VsYXRlQWxsVW5zZWxlY3RlZCgpO1xuXHR9XG5cblx0c2VsZWN0QnlJZHMoaWRzOiBBcnJheTxzdHJpbmc+LCBpdGVtRW50aXRpZXM6IEFycmF5PEl0ZW1FbnRpdHk+KTogdm9pZCB7XG5cdFx0aWYgKCF0aGlzLmVuYWJsZWQpIHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRjb25zdCBpdGVtSWRzID0gW107XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGlkcy5sZW5ndGg7IGkrKykge1xuXHRcdFx0Y29uc3QgaXRlbXMgPSBpdGVtRW50aXRpZXNcblx0XHRcdFx0LmZpbHRlcigoaXRlbTogSXRlbUVudGl0eSkgPT4ge1xuXHRcdFx0XHRcdHJldHVybiB0aGlzLm1hdGNoZXIoaXRlbS5nZXRTb3VyY2VJdGVtKCkpID09PSBpZHNbaV07XG5cdFx0XHRcdH0pXG5cdFx0XHRcdC5tYXAoKGl0ZW0pID0+IGl0ZW0uZ2V0SWQoKS50b1N0cmluZygpKTtcblxuXHRcdFx0aXRlbUlkcy5wdXNoKC4uLml0ZW1zKTtcblx0XHR9XG5cblx0XHRsZXQgdHlwZSA9IFJvd1NlbGVjdFRvZ2dsZVR5cGUuQUREO1xuXG5cdFx0aWYgKHRoaXMuc2VsZWN0aW9uLmlzU2luZ2xlKCkpIHtcblx0XHRcdHR5cGUgPSBSb3dTZWxlY3RUb2dnbGVUeXBlLk5PTkU7XG5cdFx0fVxuXG5cdFx0aXRlbUlkcy5mb3JFYWNoKChpZCkgPT4ge1xuXHRcdFx0dGhpcy50b2dnbGVSb3dCeVR5cGUodHlwZSwgaWQpO1xuXHRcdH0pO1xuXG5cdFx0dGhpcy5jYWxjdWxhdGVBbGxTZWxlY3RlZChpdGVtRW50aXRpZXMubWFwKGkgPT4gaS5nZXRJZCgpKSk7XG5cdFx0dGhpcy5jYWxjdWxhdGVBbGxVbnNlbGVjdGVkKCk7XG5cdH1cblxuXHRzZWxlY3RCeUluZGV4KGluZGV4ZXM6IEFycmF5PG51bWJlcj4sIGFsbEVudGl0eUlkczogQXJyYXk8SXRlbUVudGl0eUlkPik6IHZvaWQge1xuXHRcdGlmICghdGhpcy5lbmFibGVkKSB7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0Y29uc3QgaXRlbUlkcyA9IGluZGV4ZXMubWFwKChpKSA9PiB7XG5cdFx0XHRpZiAoIWFsbEVudGl0eUlkc1tpXSkge1xuXHRcdFx0XHRjb25zb2xlLmVycm9yKCdJdGVtIG5vdCBmb3VuZCcpO1xuXHRcdFx0fVxuXHRcdFx0cmV0dXJuIGFsbEVudGl0eUlkc1tpXS50b1N0cmluZygpO1xuXHRcdH0pO1xuXG5cdFx0bGV0IHR5cGUgPSBSb3dTZWxlY3RUb2dnbGVUeXBlLkFERDtcblxuXHRcdGlmICh0aGlzLnNlbGVjdGlvbi5pc1NpbmdsZSgpKSB7XG5cdFx0XHR0eXBlID0gUm93U2VsZWN0VG9nZ2xlVHlwZS5OT05FO1xuXHRcdH1cblxuXHRcdGl0ZW1JZHMuZm9yRWFjaCgoaWQpID0+IHtcblx0XHRcdHRoaXMudG9nZ2xlUm93QnlUeXBlKHR5cGUsIGlkKTtcblx0XHR9KTtcblxuXHRcdHRoaXMuY2FsY3VsYXRlQWxsU2VsZWN0ZWQoYWxsRW50aXR5SWRzKTtcblx0XHR0aGlzLmNhbGN1bGF0ZUFsbFVuc2VsZWN0ZWQoKTtcblx0fVxuXG5cdHNlbGVjdFJvd3MoaXRlbUlkczogQXJyYXk8c3RyaW5nPiwgaXRlbUVudGl0eUlkczogQXJyYXk8SXRlbUVudGl0eUlkPik6IHZvaWQge1xuXG5cdH1cblxuXHR0b2dnbGVSb3coaXRlbUlkOiBzdHJpbmcsIHR5cGU6IFJvd1NlbGVjdFRvZ2dsZVR5cGUsIGl0ZW1FbnRpdHlJZHM6IEFycmF5PEl0ZW1FbnRpdHlJZD4pOiB2b2lkIHtcblxuXHRcdGlmICghdGhpcy5lbmFibGVkKSB7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0aWYgKHR5cGUgPT09IFJvd1NlbGVjdFRvZ2dsZVR5cGUuQUREICYmIHRoaXMuc2VsZWN0aW9uLmlzU2luZ2xlKCkpIHtcblx0XHRcdHR5cGUgPSBSb3dTZWxlY3RUb2dnbGVUeXBlLk5PTkU7XG5cdFx0fVxuXG5cdFx0dGhpcy50b2dnbGVSb3dCeVR5cGUodHlwZSwgaXRlbUlkKTtcblxuXHRcdHRoaXMuY2FsY3VsYXRlQWxsU2VsZWN0ZWQoaXRlbUVudGl0eUlkcyk7XG5cdFx0dGhpcy5jYWxjdWxhdGVBbGxVbnNlbGVjdGVkKCk7XG5cdH1cblxuXHRjYWxjdWxhdGVBbGxTZWxlY3RlZChpdGVtRW50aXR5SWRzOiBBcnJheTxJdGVtRW50aXR5SWQ+KTogdm9pZCB7XG5cblx0XHRpZiAoaXRlbUVudGl0eUlkcy5sZW5ndGggIT09IHRoaXMuc2VsZWN0ZWRJdGVtSWRzLnNpemUpIHtcblx0XHRcdHRoaXMuYWxsU2VsZWN0ZWQgPSBmYWxzZTtcblx0XHR9IGVsc2Uge1xuXG5cdFx0XHRjb25zdCByb3dzID0gQXJyYXkuZnJvbSh0aGlzLnNlbGVjdGVkSXRlbUlkcyk7XG5cdFx0XHRsZXQgZXF1YWwgPSB0cnVlO1xuXG5cdFx0XHRyb3dzLnNvcnQoKTtcblx0XHRcdGl0ZW1FbnRpdHlJZHMuc29ydCgpO1xuXG5cdFx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHJvd3MubGVuZ3RoOyBpICs9IDEpIHtcblx0XHRcdFx0aWYgKHJvd3NbaV0gIT09IGl0ZW1FbnRpdHlJZHNbaV0udG9TdHJpbmcoKSkge1xuXHRcdFx0XHRcdGVxdWFsID0gZmFsc2U7XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdH1cblx0XHRcdH1cblxuXHRcdFx0dGhpcy5hbGxTZWxlY3RlZCA9IGVxdWFsO1xuXHRcdH1cblx0fVxuXG5cdGNhbGN1bGF0ZUFsbFVuc2VsZWN0ZWQoKTogdm9pZCB7XG5cdFx0dGhpcy5hbGxVbnNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZEl0ZW1JZHMuc2l6ZSA9PT0gMDtcblx0fVxuXG5cdHVuc2VsZWN0Um93KGl0ZW1FbnRpdHlJZDogSXRlbUVudGl0eUlkKTogdm9pZCB7XG5cdFx0aWYgKHRoaXMuc2VsZWN0ZWRJdGVtSWRzLmhhcyhpdGVtRW50aXR5SWQudG9TdHJpbmcoKSkpIHtcblx0XHRcdHRoaXMuc2VsZWN0ZWRJdGVtSWRzLmRlbGV0ZShpdGVtRW50aXR5SWQudG9TdHJpbmcoKSk7XG5cdFx0fVxuXHR9XG5cblx0Z2V0SWQoKTogU3RydWN0dXJlSWQge1xuXHRcdHJldHVybiB0aGlzLmlkO1xuXHR9XG5cblx0Z2V0VHlwZSgpOiBSb3dTZWxlY3Rpb25UeXBlIHtcblx0XHRyZXR1cm4gdGhpcy5zZWxlY3Rpb24uZ2V0VHlwZSgpO1xuXHR9XG5cblx0cHJpdmF0ZSB0b2dnbGVSb3dCeVR5cGUodHlwZTogUm93U2VsZWN0VG9nZ2xlVHlwZSwgaXRlbUlkOiBzdHJpbmcpIHtcblxuXHRcdHN3aXRjaCAodHlwZSkge1xuXHRcdFx0Y2FzZSBSb3dTZWxlY3RUb2dnbGVUeXBlLk5PTkU6XG5cblx0XHRcdFx0aWYgKHRoaXMuc2VsZWN0ZWRJdGVtSWRzLmhhcyhpdGVtSWQpKSB7XG5cdFx0XHRcdFx0dGhpcy5zZWxlY3RlZEl0ZW1JZHMuZGVsZXRlKGl0ZW1JZCk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0dGhpcy5zZWxlY3RlZEl0ZW1JZHMuY2xlYXIoKTtcblx0XHRcdFx0XHR0aGlzLnNlbGVjdGVkSXRlbUlkcy5hZGQoaXRlbUlkKTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGJyZWFrO1xuXG5cdFx0XHRjYXNlIFJvd1NlbGVjdFRvZ2dsZVR5cGUuQUREOlxuXG5cdFx0XHRcdGlmICh0aGlzLnNlbGVjdGVkSXRlbUlkcy5oYXMoaXRlbUlkKSkge1xuXHRcdFx0XHRcdHRoaXMuc2VsZWN0ZWRJdGVtSWRzLmRlbGV0ZShpdGVtSWQpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHRoaXMuc2VsZWN0ZWRJdGVtSWRzLmFkZChpdGVtSWQpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0YnJlYWs7XG5cblx0XHRcdGNhc2UgUm93U2VsZWN0VG9nZ2xlVHlwZS5SQU5HRTpcblxuXHRcdFx0XHRicmVhaztcblxuXHRcdFx0ZGVmYXVsdDpcblx0XHRcdFx0YnJlYWs7XG5cdFx0fVxuXHR9XG59XG4iXX0=